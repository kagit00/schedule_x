<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">

    <changeSet id="create-matches-table" author="grok">
        <createTable tableName="matches">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="group_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="user_id_1" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="user_id_2" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="compatibility_score" type="double">
                <constraints nullable="false"/>
            </column>
            <column name="matched_at" type="timestamp"/>
            <column name="processing_cycle_id" type="varchar(255)"/>
        </createTable>
    </changeSet>

    <changeSet id="create-potential-matches-table_" author="grok">
        <createTable tableName="potential_matches">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="group_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="user_id_1" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="user_id_2" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="compatibility_score" type="double">
                <constraints nullable="false"/>
            </column>
            <column name="matched_at" type="timestamp"/>
        </createTable>
    </changeSet>

    <changeSet id="rename-columns-to-align-with-pojos" author="grok">
        <renameColumn
                tableName="matches"
                oldColumnName="user_id_1"
                newColumnName="reference_id"
                columnDataType="varchar(255)"/>
        <renameColumn
                tableName="matches"
                oldColumnName="user_id_2"
                newColumnName="matched_reference_id"
                columnDataType="varchar(255)"/>
        <renameColumn
                tableName="potential_matches"
                oldColumnName="user_id_1"
                newColumnName="reference_id"
                columnDataType="varchar(255)"/>
        <renameColumn
                tableName="potential_matches"
                oldColumnName="user_id_2"
                newColumnName="matched_reference_id"
                columnDataType="varchar(255)"/>
    </changeSet>

    <changeSet id="rename-matches-to-perfect-matches" author="grok">
        <renameTable
                oldTableName="matches"
                newTableName="perfect_matches"/>
    </changeSet>

    <changeSet id="add-indexes-potential-matches" author="grok">
        <createIndex indexName="idx_potential_match_group_id" tableName="potential_matches">
            <column name="group_id"/>
        </createIndex>
        <createIndex indexName="idx_potential_match_reference_id" tableName="potential_matches">
            <column name="reference_id"/>
        </createIndex>
        <createIndex indexName="idx_potential_match_matched_reference_id" tableName="potential_matches">
            <column name="matched_reference_id"/>
        </createIndex>
        <createIndex indexName="idx_potential_match_participants" tableName="potential_matches">
            <column name="reference_id"/>
            <column name="matched_reference_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="add-domain-id-matches" author="grok">
        <addColumn tableName="perfect_matches">
            <column name="domain_id" type="UUID">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="potential_matches">
            <column name="domain_id" type="UUID">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <sql>
            UPDATE perfect_matches SET domain_id = (SELECT id FROM domains WHERE name = 'flairbit') WHERE domain_id IS NULL;
            UPDATE potential_matches SET domain_id = (SELECT id FROM domains WHERE name = 'flairbit') WHERE domain_id IS NULL;
        </sql>
        <createIndex indexName="idx_perfect_match_domain_group" tableName="perfect_matches">
            <column name="domain_id"/>
            <column name="group_id"/>
        </createIndex>
        <createIndex indexName="idx_potential_match_domain_group" tableName="potential_matches">
            <column name="domain_id"/>
            <column name="group_id"/>
        </createIndex>
        <addForeignKeyConstraint
                baseTableName="perfect_matches"
                baseColumnNames="domain_id"
                referencedTableName="domains"
                referencedColumnNames="id"
                constraintName="fk_perfect_matches_domain"/>
        <addForeignKeyConstraint
                baseTableName="potential_matches"
                baseColumnNames="domain_id"
                referencedTableName="domains"
                referencedColumnNames="id"
                constraintName="fk_potential_matches_domain"/>
    </changeSet>

    <changeSet id="add-unique-constraint-potential-matches" author="your-name">
        <addUniqueConstraint
                tableName="potential_matches"
                columnNames="group_id, reference_id, matched_reference_id"
                constraintName="uq_potential_matches_triplet"/>
    </changeSet>

    <changeSet id="add-unique-constraint-perfect-matches" author="your-name">
        <addUniqueConstraint
                tableName="perfect_matches"
                columnNames="group_id, reference_id, matched_reference_id"
                constraintName="uq_perfect_matches_triplet"/>
    </changeSet>

    <changeSet id="update-topkweightedgreedy-for-default-groups" author="chatgpt">
        <update tableName="matching_configurations">
            <column name="algorithm_id" valueComputed="(
            SELECT id FROM matching_algorithms WHERE name = 'Top K Weighted Greedy Matching Strategy' LIMIT 1
        )"/>
            <where>
                group_id IN (
                SELECT id FROM matching_groups
                WHERE group_id IN ('dating-default', 'marriage-default')
                )
            </where>
        </update>
    </changeSet>


    <changeSet id="create_last_run_perfect_matches_table" author="grok">
        <createTable tableName="last_run_perfect_matches">
            <column name="id" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="group_id" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="domain_id" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="node_count" type="bigint"/>
            <column name="run_date" type="timestamp"/>
            <column name="status" type="varchar(50)"/>
        </createTable>
    </changeSet>

    <changeSet id="20250607-01-alter-perfect_matches-column" author="kaustav">
        <modifyDataType
                tableName="perfect_matches"
                columnName="group_id"
                newDataType="UUID" />
    </changeSet>

    <changeSet id="20250607-01-alter-potential_matches-column" author="kaustav">
        <modifyDataType
                tableName="potential_matches"
                columnName="group_id"
                newDataType="UUID" />
    </changeSet>

    <changeSet id="20250607-01-alter-last_run_perfect_matches-column" author="kaustav">
        <modifyDataType
                tableName="last_run_perfect_matches"
                columnName="group_id"
                newDataType="UUID" />
    </changeSet>

    <changeSet id="20250525-02-processing_cycle_id_potential_matches_" author="grok" runInTransaction="false">
        <sql>
            ALTER TABLE potential_matches
            ADD COLUMN IF NOT EXISTS processing_cycle_id varchar(255);
        </sql>
    </changeSet>

    <changeSet id="add-processing-cycle-id-column" author="you">
        <addColumn tableName="match_participation_history">
            <column name="processing_cycle_id" type="varchar(50)"/>
        </addColumn>
    </changeSet>

    <changeSet id="2025.12.11-01-add-unique-constraint-and-defaults" author="grok">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="last_run_perfect_matches"/>
            <not>
                <uniqueConstraintExists tableName="last_run_perfect_matches" constraintName="uk_last_run_domain_group"/>
            </not>
        </preConditions>

        <addDefaultValue tableName="last_run_perfect_matches" columnName="node_count" defaultValueNumeric="0"/>
        <addNotNullConstraint tableName="last_run_perfect_matches" columnName="node_count" columnDataType="bigint"/>

        <addDefaultValue tableName="last_run_perfect_matches" columnName="status" defaultValue="COMPLETED"/>
        <addNotNullConstraint tableName="last_run_perfect_matches" columnName="status" columnDataType="varchar(50)"/>

        <addUniqueConstraint tableName="last_run_perfect_matches"
                             constraintName="uk_last_run_domain_group"
                             columnNames="domain_id,group_id"/>
    </changeSet>

</databaseChangeLog>